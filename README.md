C3S PQAR Code
=============

The scripts in this repository are used to generate the SST validation plots used
in the C3S Product Quality Assessment Reports. Required inputs are the SST CCI
Independent Reference Data Set (SIRDS) available from:
https://www.metoffice.gov.uk/hadobs/hadiod/sirds.html and a selection of L3C or
L4 SST files.

gen_*_mmd.py
------------

The `gen_sst_mmd.py` and `gen_l4_mmd.py` programs are used to match the SIRDS
data to Level 3 and Level 4 satellite data products. Usually these will be
submitted as batch jobs to the cluster using the `submit_gen*` scripts, but they
may also be run manually.
```
usage: gen_sst_mmd.py [-h] [-d DIR] sirds satpath

positional arguments:
  sirds       SIRDS file
  satpath     Path to L3 or L4 data

optional arguments:
  -h, --help  show this help message and exit
  -d DIR      Output directory
```

### Example
The following code will generate a MD file using CMEMS drifters for July 2019.
The satellite SSTs are taken from SLSTR L3C in the `v3.0.1` output directory.
```bash
#!/usr/bin/env bash
spath=/gws/nopw/j04/cds_c3s_sst/input/refdata/raw/sirds
base=/gws/nopw/j04/cds_c3s_sst/output/v3.0.1

./gen_sst_mmd.py -d=${base}/mmd/l3c/SLSTRA ${spath}/SSTCCI2_refdata_drifter_cmems_201907.nc ${base}/l3c/SLSTRA
```


submit_gen_mmd.py
-------------------
The `submit_gen_mmd.py` script may be used to generate MD files for a range of
months. By default this is done by submitting a batch of MD generation jobs to
the Jasmin Slurm cluster, but there is also an option to run them locally on a
normal desktop computer.

```
usage: submit_gen_mmd.py [-h] [--sirdspath PATH] [--data_type {l3,l4}]
                         [--itype ITYPE] [--interactive]
                         startdate enddate satpath

positional arguments:
  startdate            Start date - format: 'YYYYMM'
  enddate              End date - format: 'YYYYMM'
  satpath              Location of L3 / L4 data

options:
  -h, --help           show this help message and exit
  --sirdspath PATH     Location of SIRDS data files
  --data_type {l3,l4}  Satellite data type: l3 (default) or l4
  --itype ITYPE        Type of insitu observation to use (default
                       drifter_cmems)
  --interactive        Run tasks immediately (default is to submit to batch
                       system)
```

### Example
The following runs on a desktop to generate all matches from CMEMS drifters to L4 SSTs

```bash
#!/usr/bin/env bash

base=/gws/nopw/j04/cds_c3s_sst/output/v3.0.1

./submit_gen_mmd.py 200001 200002 --satpath=$base/l4/OSTIA --sirdspath=$base/sirds --data_type=l4 --itype=drifter_cmems --interactive


```


c3s_pvir_plots.py
-----------------
The plot script will read the MD files generated by the above scripts and produce
the standard PQAR plots.
```
usage: c3s_pvir_plots.py [-h] [--sat SAT] [--dir DIR] [--quality QUALITY]
                         [--filequal FILEQUAL] [--prefix PREFIX]
                         [--extra EXTRA] [--insitu_type INSITU_TYPE]
                         [--sirds_type SIRDS_TYPE] [--dtime DTIME]
                         files [files ...]

positional arguments:
  files                 MMD file[s] to process

options:
  -h, --help            show this help message and exit
  --sat SAT             Sensor name (for plot titles)
  --dir DIR             Output directory
  --quality QUALITY     quality_level to validate (L3 only)
  --filequal FILEQUAL   Minimum file quality level
  --prefix PREFIX       prefix for output files
  --extra EXTRA         suffix for output files (excluding file extension)
  --insitu_type INSITU_TYPE
                        In situ type (for uncertainty plots)
  --sirds_type SIRDS_TYPE
                        Override sirds type in plot filenames
  --dtime DTIME         Delta-time limit (hours)
```

### Example
The following example generates the C3S PQAR plots for the ICDR data
```bash
#!/usr/bin/env bash

./c3s_pvir_plots.py mmd/ICDRv2/l3c/AVHRR19_G/* --dir=ICDRv2
./c3s_pvir_plots.py mmd/ICDRv2/l3c/AVHRRMTA_G/* --dir=ICDRv2
./c3s_pvir_plots.py mmd/ICDRv2/l3c/SLSTRA/* --dir=ICDRv2
./c3s_pvir_plots.py mmd/ICDRv2/l3c/SLSTRB/* --dir=ICDRv2

./c3s_pvir_plots.py mmd/ICDRv2/l4/OSTIA/* --dir=ICDRv2
```
